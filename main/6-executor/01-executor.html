<!DOCTYPE html>
<html lang="en">

<head>
    <base href="/tanka-graphql/">
    <title>01-executor - Tanka GraphQL</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    
    <!-- Noto Color Emoji font for cross-platform emoji support -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&display=swap" rel="stylesheet">
    
    <!-- Highlight.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">

    <style>
        :root {
            --bs-body-font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", sans-serif;
            --bs-link-color-rgb: 8, 87, 168;
            --bs-link-hover-color-rgb: 6, 68, 130;
        }

        body {
            font-family: var(--bs-body-font-family);
        }

        .sidebar {
            position: sticky;
            top: 56px; /* Height of navbar */
            height: calc(100vh - 56px);
            overflow-y: auto;
            background-color: #f8f9fa;
            border-right: 1px solid #dee2e6;
            padding-top: 1rem;
        }

        .toc-sidebar {
            position: sticky;
            top: 56px; /* Height of navbar */
            height: calc(100vh - 56px);
            overflow-y: auto;
            padding-top: 1rem;
        }

        /* Mobile TOC styling - single responsive TOC */
        @media (max-width: 991.98px) {
            .toc-sidebar {
                position: static !important;
                height: auto !important;
                max-height: 300px;
                overflow-y: auto;
                background-color: #f8f9fa;
                border: 1px solid #dee2e6;
                border-radius: 0.375rem;
                margin-bottom: 1rem;
                padding: 1rem;
                /* Move TOC to mobile position - above content */
                order: -1;
                display: block !important; /* Override Bootstrap d-none d-lg-block */
            }

            .toc-sidebar.collapsed {
                display: none !important;
            }

            .toc-sidebar .toc-title {
                display: none; /* Hide desktop title on mobile */
            }

            /* Adjust main content layout for mobile */
            .content {
                order: 0;
            }
        }

        .toc-toggle {
            display: none;
        }

        @media (max-width: 991.98px) {
            .toc-toggle {
                display: inline-block;
            }
        }

        .sidebar .nav-link {
            font-size: 0.9rem;
            color: #495057;
        }

        .sidebar .nav-link.active, .sidebar .nav-link:hover {
            color: rgb(var(--bs-link-color-rgb));
            font-weight: 500;
        }

        /* Ensure emojis render properly in navigation */
        .sidebar .nav-link {
            font-feature-settings: "liga" on, "clig" on;
            text-rendering: optimizeLegibility;
            font-family: var(--bs-body-font-family);
        }
        
        .toc-sidebar .nav-link {
            font-size: 0.8rem;
            color: #6c757d;
            padding-top: 0.25rem;
            padding-bottom: 0.25rem;
        }

        .toc-sidebar .nav-link:hover {
            color: #212529;
        }

        .toc-sidebar .nav-link.active {
            font-weight: 600;
            color: #212529; /* Darker text for readability */
            border-left: 2px solid rgb(var(--bs-link-color-rgb));
        }

        blockquote {
            font-size: 1rem;
            border-left: 4px solid #adb5bd;
            padding-left: 1rem;
            color: #6c757d;
        }

        .content h1, .content h2, .content h3, .content h4, .content h5, .content h6 {
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }

        .content h2, .content h3 {
            scroll-margin-top: 80px;
        }

        /* Adjust code block styling to match highlight.js theme */
        pre code.hljs {
            border-radius: 0.3rem;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Tanka GraphQL</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a class="nav-link" href="main/index.html">Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="main/0-getting-started/00-getting-started.html">Getting Started</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="main/10-extensions/tracing.html">Extensions</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="main/2-language/01-parser.html">Language</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="main/3-server/00-index.html">Server</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="main/4-code-generator/01-samples-sg-basic.html">Code Generation</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="main/6-executor/01-executor.html">Executor</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="main/7-type-system/02-schema.html">Type System</a>
                        </li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="https://github.com/pekkah/tanka-graphql" target="_blank" rel="noopener">GitHub</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            main
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownMenuLink">
                                <li><a class="dropdown-item" href="/tanka-graphql/main">main</a></li>
                                <li><a class="dropdown-item" href="/tanka-graphql/3.0.0">3.0.0</a></li>
                                <li><a class="dropdown-item" href="/tanka-graphql/2.0.1">2.0.1</a></li>
                                <li><a class="dropdown-item" href="/tanka-graphql/2.0.0">2.0.0</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container-fluid">
        <div class="row">
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
    <nav class="nav flex-column">
<li class="nav-item">
    <div class="d-flex justify-content-between align-items-center">
        <a class="nav-link" href=main/6-executor/01-executor.html>Executor</a>
        <a class="btn btn-sm" data-bs-toggle="collapse" href="#nav-01-executor.md" role="button" aria-expanded="false" aria-controls="nav-01-executor.md">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>
        </a>
    </div>
    <div class="collapse" id="nav-01-executor.md">
        <ul class="nav flex-column ms-3">
<li class="nav-item">
    <div class="d-flex justify-content-between align-items-center">
        <a class="nav-link" href=main/6-executor/02-simple-usage.html>Simple Usage</a>
    </div>
</li><li class="nav-item">
    <div class="d-flex justify-content-between align-items-center">
        <a class="nav-link" href=main/6-executor/03-queries-and-mutations.html>Queries and mutations</a>
    </div>
</li><li class="nav-item">
    <div class="d-flex justify-content-between align-items-center">
        <a class="nav-link" href=main/6-executor/04-subscriptions.html>Subscriptions</a>
    </div>
</li>        </ul>
    </div>
</li>    </nav>
    <nav class="nav flex-column">
<li class="nav-item">
    <div class="d-flex justify-content-between align-items-center">
        <a class="nav-link" href=main/6-executor/05-pipeline.html>Pipeline</a>
        <a class="btn btn-sm" data-bs-toggle="collapse" href="#nav-05-pipeline.md" role="button" aria-expanded="false" aria-controls="nav-05-pipeline.md">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>
        </a>
    </div>
    <div class="collapse" id="nav-05-pipeline.md">
        <ul class="nav flex-column ms-3">
<li class="nav-item">
    <div class="d-flex justify-content-between align-items-center">
        <a class="nav-link" href=main/6-executor/06-pipeline-operation.html>Operation</a>
    </div>
</li><li class="nav-item">
    <div class="d-flex justify-content-between align-items-center">
        <a class="nav-link" href=main/6-executor/07-pipeline-selection-sets.html>SelectionSet</a>
    </div>
</li><li class="nav-item">
    <div class="d-flex justify-content-between align-items-center">
        <a class="nav-link" href=main/6-executor/08-pipeline-fields.html>Fields</a>
    </div>
</li><li class="nav-item">
    <div class="d-flex justify-content-between align-items-center">
        <a class="nav-link" href=main/6-executor/09-pipeline-resolvers.html>Resolver</a>
    </div>
</li><li class="nav-item">
    <div class="d-flex justify-content-between align-items-center">
        <a class="nav-link" href=main/6-executor/10-pipeline-subscribers.html>Subscriber</a>
    </div>
</li>        </ul>
    </div>
</li>    </nav>
            </nav>
            <main class="col-md-6 ms-sm-auto col-lg-7 px-md-4 py-3 content d-flex flex-column">
                <!-- Mobile TOC toggle button -->
                <div class="d-lg-none mb-3">
                    <button id="toc-toggle" class="btn btn-outline-secondary btn-sm toc-toggle mb-2" type="button">
                        <svg width="16" height="16" fill="currentColor" class="bi bi-list" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/>
                        </svg>
                        <span class="ms-1">On this page</span>
                    </button>
                </div>
                <h2 id="executor">Executor</h2>
<p>GraphQL operations are executor by the GraphQL Executor. The executor is responsible for executing the GraphQL operation and returning the result. The executor is also responsible for handling errors and returning the appropriate error response.</p>
<p>The executor uses <code>OperationDelegate</code> to execute the GraphQL operation pipeline. Inputs and outputs to and from the pipeline are contained in the <code>QueryContext</code> class which is passed to the delegate by the executor.</p>
<h3 id="operationdelegate">OperationDelegate</h3>
<p>The <code>OperationDelegate</code> is a delegate that represents the GraphQL operation pipeline. It is responsible for executing the GraphQL operation and returning the result. The <code>OperationDelegate</code> is defined as follows:</p>
<pre><code class="language-csharp">public delegate Task OperationDelegate(QueryContext context);
</code></pre>
<p>The <code>OperationDelegate</code> takes a <code>QueryContext</code> as a parameter and returns a <code>Task</code>. The <code>QueryContext</code> contains the inputs and outputs to and from the pipeline.</p>
<h3 id="querycontext">QueryContext</h3>
<p>The <code>QueryContext</code> class is used to pass inputs and outputs to and from the GraphQL operation pipeline. It contains the following properties:</p>
<ul>
<li><code>Request</code>: The <code>GraphQLRequest</code> object that contains the GraphQL query, variables, and other request-related information.</li>
<li><code>RequestCancelled</code>: A <code>CancellationToken</code> that can be used to cancel the request.</li>
<li><code>Features</code>: A collection of features that can be used to extend the functionality of the <code>QueryContext</code>.</li>
<li><code>CoercedVariableValues</code>: A dictionary that contains the coerced variable values.</li>
<li><code>OperationDefinition</code>: The <code>OperationDefinition</code> object that represents the GraphQL operation to be executed.</li>
<li><code>Schema</code>: The <code>ISchema</code> object that represents the GraphQL schema.</li>
<li><code>Response</code>: An <code>IAsyncEnumerable&lt;ExecutionResult&gt;</code> that represents the response stream.</li>
<li><code>RequestServices</code>: An <code>IServiceProvider</code> that can be used to resolve services.</li>
</ul>
<p>The <code>QueryContext</code> class also contains methods for adding errors, completing values, executing fields, executing selection sets, and getting errors.</p>
<h3 id="executor-methods">Executor Methods</h3>
<p>The <code>Executor</code> class has several methods for executing GraphQL operations. The following sections provide detailed explanations and examples of these methods.</p>
<h4 id="execute-method">Execute Method</h4>
<p>The <code>Execute</code> method is used to execute a GraphQL query or mutation. It takes a <code>GraphQLRequest</code> object as a parameter and returns an <code>ExecutionResult</code>. The <code>Execute</code> method is defined as follows:</p>
<pre><code class="language-csharp">public async Task&lt;ExecutionResult&gt; Execute(GraphQLRequest request, CancellationToken cancellationToken = default)
{
    QueryContext queryContext = BuildQueryContextAsync(request);
    queryContext.RequestCancelled = cancellationToken;

    IAsyncEnumerable&lt;ExecutionResult&gt; executionResult = ExecuteOperation(queryContext);

    return await executionResult.SingleAsync(queryContext.RequestCancelled);
}
</code></pre>
<p>The following example shows how to use the <code>Execute</code> method to execute a GraphQL query:</p>
<pre><code class="language-csharp">var schema = new Schema();
var executor = new Executor(schema);

var request = new GraphQLRequest
{
    Query = &quot;&quot;&quot;
    {
        hello
    }
    &quot;&quot;&quot;
};

var result = await executor.Execute(request);

Console.WriteLine(result.Data);
</code></pre>
<h4 id="executequeryormutation-method">ExecuteQueryOrMutation Method</h4>
<p>The <code>ExecuteQueryOrMutation</code> method is a static method that is used to execute a query or mutation operation. It takes a <code>QueryContext</code> as a parameter and returns a <code>Task</code>. The <code>ExecuteQueryOrMutation</code> method is defined as follows:</p>
<pre><code class="language-csharp">public static async Task ExecuteQueryOrMutation(QueryContext context)
{
    var path = new NodePath();
    ObjectDefinition? rootType = context.OperationDefinition.Operation switch
    {
        OperationType.Query =&gt; context.Schema.Query,
        OperationType.Mutation =&gt; context.Schema.Mutation,
        _ =&gt; throw new ArgumentOutOfRangeException()
    };

    if (rootType == null)
        throw new QueryException(
            $&quot;Schema does not support '{context.OperationDefinition.Operation}'. Root type not set.&quot;)
        {
            Path = path
        };

    SelectionSet selectionSet = context.OperationDefinition.SelectionSet;

    try
    {
        IReadOnlyDictionary&lt;string, object?&gt; result = await context.ExecuteSelectionSet(
            selectionSet,
            rootType,
            context.Request.InitialValue,
            path);

        context.Response = AsyncEnumerableEx.Return(new ExecutionResult
        {
            Data = result,
            Errors = context.GetErrors().ToList()
        });
        return;
    }
    catch (FieldException e)
    {
        context.AddError(e);
    }

    context.Response = AsyncEnumerableEx.Return(new ExecutionResult
    {
        Data = null,
        Errors = context.GetErrors().ToList()
    });
}
</code></pre>
<p>The following example shows how to use the <code>ExecuteQueryOrMutation</code> method to execute a GraphQL query:</p>
<pre><code class="language-csharp">var schema = new Schema();
var executor = new Executor(schema);

var request = new GraphQLRequest
{
    Query = &quot;&quot;&quot;
    {
        hello
    }
    &quot;&quot;&quot;
};

var queryContext = executor.BuildQueryContextAsync(request);
await Executor.ExecuteQueryOrMutation(queryContext);

var result = await queryContext.Response.SingleAsync();

Console.WriteLine(result.Data);
</code></pre>
<h4 id="executesubscription-method">ExecuteSubscription Method</h4>
<p>The <code>ExecuteSubscription</code> method is a static method that is used to execute a subscription operation. It takes a <code>QueryContext</code> as a parameter and returns a <code>Task</code>. The <code>ExecuteSubscription</code> method is defined as follows:</p>
<pre><code class="language-csharp">public static async Task ExecuteSubscription(QueryContext context)
{
    context.RequestCancelled.ThrowIfCancellationRequested();

    IAsyncEnumerable&lt;object?&gt; sourceStream = await CreateSourceEventStream(
        context,
        context.RequestCancelled);

    IAsyncEnumerable&lt;ExecutionResult&gt; responseStream = MapSourceToResponseEventStream(
        context,
        sourceStream,
        context.RequestCancelled);

    context.Response = responseStream;
}
</code></pre>
<p>The following example shows how to use the <code>ExecuteSubscription</code> method to execute a GraphQL subscription:</p>
<pre><code class="language-csharp">var schema = new Schema();
var executor = new Executor(schema);

var request = new GraphQLRequest
{
    Query = &quot;&quot;&quot;
    subscription {
        messageAdded
    }
    &quot;&quot;&quot;
};

var queryContext = executor.BuildQueryContextAsync(request);
await Executor.ExecuteSubscription(queryContext);

await foreach (var result in queryContext.Response)
{
    Console.WriteLine(result.Data);
}
</code></pre>
<h3 id="pipeline-structure-and-flow">Pipeline Structure and Flow</h3>
<p>The GraphQL execution pipeline is a series of middleware components that process a GraphQL request. Each middleware component in the pipeline has the opportunity to inspect, modify, or short-circuit the request and response. The pipeline is defined using the <code>OperationDelegateBuilder</code> class.</p>
<h4 id="defining-the-pipeline">Defining the Pipeline</h4>
<p>The pipeline is defined using the <code>OperationDelegateBuilder</code> class. The <code>OperationDelegateBuilder</code> class provides methods for adding middleware components to the pipeline. The following example shows how to define a simple pipeline:</p>
<pre><code class="language-csharp">var builder = new OperationDelegateBuilder();

builder.Use(next =&gt; async context =&gt;
{
    // Middleware component 1
    Console.WriteLine(&quot;Before Middleware 1&quot;);
    await next(context);
    Console.WriteLine(&quot;After Middleware 1&quot;);
});

builder.Use(next =&gt; async context =&gt;
{
    // Middleware component 2
    Console.WriteLine(&quot;Before Middleware 2&quot;);
    await next(context);
    Console.WriteLine(&quot;After Middleware 2&quot;);
});

var pipeline = builder.Build();
</code></pre>
<p>In this example, the pipeline consists of two middleware components. Each middleware component writes a message to the console before and after calling the next middleware component in the pipeline.</p>
<h4 id="using-the-pipeline">Using the Pipeline</h4>
<p>The pipeline is used to process a GraphQL request. The following example shows how to use the pipeline to process a GraphQL request:</p>
<pre><code class="language-csharp">var schema = new Schema();
var executor = new Executor(schema);

var request = new GraphQLRequest
{
    Query = &quot;&quot;&quot;
    {
        hello
    }
    &quot;&quot;&quot;
};

var queryContext = executor.BuildQueryContextAsync(request);
await pipeline(queryContext);

var result = await queryContext.Response.SingleAsync();

Console.WriteLine(result.Data);
</code></pre>
<p>In this example, the pipeline is used to process a GraphQL request. The <code>pipeline</code> delegate is called with the <code>queryContext</code> object, which contains the GraphQL request and other context information. The <code>queryContext.Response</code> property contains the response stream, which is an <code>IAsyncEnumerable&lt;ExecutionResult&gt;</code>.</p>
<h4 id="pipeline-flowchart">Pipeline Flowchart</h4>
<p>The following flowchart visually represents the pipeline structure and flow:</p>
<pre><code class="language-plaintext">+-------------------+       +-------------------+       +-------------------+
| Middleware 1      | ----&gt; | Middleware 2      | ----&gt; | Middleware 3      |
|                   |       |                   |       |                   |
| - Before          |       | - Before          |       | - Before          |
| - Next(context)   |       | - Next(context)   |       | - Next(context)   |
| - After           |       | - After           |       | - After           |
+-------------------+       +-------------------+       +-------------------+
</code></pre>
<p>In this flowchart, each middleware component is represented by a box. The arrows indicate the flow of the request and response through the pipeline. Each middleware component has the opportunity to inspect, modify, or short-circuit the request and response.</p>
<p><a href="main/6-executor/02-simple-usage.html">Next</a></p>

            </main>
            <!-- Single responsive TOC -->
            <nav id="toc" class="col-md-3 col-lg-3 d-none d-lg-block toc-sidebar collapsed">
                <strong class="d-block h6 my-2 pb-2 border-bottom toc-title">On this page</strong>
                <nav class="nav flex-column"></nav>
            </nav>
        </div>
    </div>
    
    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    
    <!-- Highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>

    <script>
        (function() {

            // Left sidebar active link
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                const baseHref = document.baseURI;
                const currentPageHref = window.location.href.split('#')[0]; // Ignore hash
                let currentPagePath = currentPageHref.substring(baseHref.length);

                if (currentPagePath.endsWith('/')) {
                    currentPagePath = currentPagePath.slice(0, -1);
                }

                const navLinks = sidebar.querySelectorAll('a.nav-link');
                navLinks.forEach(link => {
                    const linkHref = link.getAttribute('href');
                    if (linkHref && (linkHref === currentPagePath || linkHref === currentPagePath + '/index.html')) {
                        link.classList.add('active');

                        let parentCollapse = link.closest('.collapse');
                        while(parentCollapse) {
                            parentCollapse.classList.add('show');
                            const trigger = document.querySelector(`a[data-bs-toggle="collapse"][href="#${parentCollapse.id}"]`);
                            if (trigger) {
                                trigger.setAttribute('aria-expanded', 'true');
                                trigger.classList.remove('collapsed');
                            }
                            parentCollapse = parentCollapse.parentElement.closest('.collapse');
                        }
                    }
                });
            }

            // "On this page" TOC script - single responsive TOC
            const toc = document.getElementById('toc');
            const tocToggle = document.getElementById('toc-toggle');
            
            // Constants
            const SCROLL_OFFSET = 100;
            const SCROLL_THROTTLE_MS = 25; // Optimized from 10ms
            const SCROLL_NAVIGATION_TIMEOUT_MS = 200;
            const MOBILE_BREAKPOINT = 992;
            
            if (toc) {
                const mainContent = document.querySelector('.content');
                if (!mainContent) return;
                
                const headings = mainContent.querySelectorAll('h2, h3');
                const tocNav = toc.querySelector('.nav');
                
                if (!tocNav) return;
                
                if (headings.length > 0) {
                    let isScrolling = false;
                    
                    // Create TOC links
                    headings.forEach((heading, index) => {
                        const id = 'heading-' + index;
                        if (!heading.getAttribute('id')) {
                            heading.setAttribute('id', id);
                        }

                        const link = document.createElement('a');
                        link.classList.add('nav-link');
                        if (heading.tagName === 'H3') {
                            link.classList.add('ms-3'); // Indent H3
                        }
                        
                        const href = '#' + id;
                        link.setAttribute('href', href);
                        link.textContent = heading.textContent;

                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            
                            // Temporarily disable scroll tracking during navigation
                            isScrolling = true;
                            
                            // Remove active class from all TOC links
                            tocNav.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                            
                            // Add active class to clicked link
                            link.classList.add('active');
                            
                            // On mobile, collapse the TOC after clicking a link
                            if (window.innerWidth < MOBILE_BREAKPOINT && toc) {
                                toc.classList.add('collapsed');
                                if (tocToggle) {
                                    updateToggleButton(true);
                                }
                            }
                            
                            // Navigate to the hash
                            window.location.hash = href;
                            
                            // Re-enable scroll tracking after navigation completes
                            let scrollTimeout;
                            const handleScroll = () => {
                                clearTimeout(scrollTimeout);
                                scrollTimeout = setTimeout(() => {
                                    window.removeEventListener('scroll', handleScroll);
                                    isScrolling = false;
                                }, SCROLL_NAVIGATION_TIMEOUT_MS);
                            };
                            
                            window.addEventListener('scroll', handleScroll);
                            
                            // Fallback: re-enable after 1 second
                            setTimeout(() => {
                                window.removeEventListener('scroll', handleScroll);
                                isScrolling = false;
                            }, 1000);
                        });
                        
                        tocNav.appendChild(link);
                    });

                    // Update toggle button appearance
                    const updateToggleButton = (isCollapsed) => {
                        if (!tocToggle) return;
                        
                        if (isCollapsed) {
                            tocToggle.innerHTML = `<svg width="16" height="16" fill="currentColor" class="bi bi-list" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/>
                            </svg><span class="ms-1">On this page</span>`;
                        } else {
                            tocToggle.innerHTML = `<svg width="16" height="16" fill="currentColor" class="bi bi-chevron-up" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M7.646 4.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1-.708.708L8 5.707l-5.646 5.647a.5.5 0 0 1-.708-.708l6-6z"/>
                            </svg><span class="ms-1">Hide</span>`;
                        }
                    };

                    // Set initial active state based on current scroll position or hash
                    const setInitialActiveState = () => {
                        const hash = window.location.hash;
                        if (hash && tocNav) {
                            const targetLink = tocNav.querySelector(`a[href="${hash}"]`);
                            if (targetLink) {
                                tocNav.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                                targetLink.classList.add('active');
                                return;
                            }
                        }
                        
                        // Find the currently visible heading
                        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                        let activeHeading = null;
                        
                        for (let i = 0; i < headings.length; i++) {
                            const heading = headings[i];
                            const rect = heading.getBoundingClientRect();
                            const headingTop = rect.top + scrollTop;
                            
                            if (headingTop <= scrollTop + SCROLL_OFFSET) {
                                activeHeading = heading;
                            } else {
                                break;
                            }
                        }
                        
                        if (activeHeading && tocNav) {
                            const activeId = activeHeading.getAttribute('id');
                            const activeLink = tocNav.querySelector(`a[href="#${activeId}"]`);
                            if (activeLink) {
                                tocNav.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                                activeLink.classList.add('active');
                            }
                        } else if (tocNav) {
                            // If no heading is visible, activate the first one
                            const firstLink = tocNav.querySelector('.nav-link');
                            if (firstLink) {
                                firstLink.classList.add('active');
                            }
                        }
                    };

                    // Set initial active state
                    setInitialActiveState();

                    // Optimized scroll tracking
                    const updateActiveOnScroll = () => {
                        if (isScrolling || !tocNav) return;
                        
                        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                        let activeHeading = null;
                        
                        for (let i = 0; i < headings.length; i++) {
                            const heading = headings[i];
                            const rect = heading.getBoundingClientRect();
                            const headingTop = rect.top + scrollTop;
                            
                            if (headingTop <= scrollTop + SCROLL_OFFSET) {
                                activeHeading = heading;
                            } else {
                                break;
                            }
                        }
                        
                        const currentActiveLink = tocNav.querySelector('.nav-link.active');
                        let newActiveLink = null;
                        
                        if (activeHeading) {
                            const activeId = activeHeading.getAttribute('id');
                            newActiveLink = tocNav.querySelector(`a[href="#${activeId}"]`);
                        } else {
                            newActiveLink = tocNav.querySelector('.nav-link');
                        }
                        
                        if (newActiveLink && newActiveLink !== currentActiveLink) {
                            tocNav.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                            newActiveLink.classList.add('active');
                        }
                    };
                    
                    // Throttled scroll listener
                    let scrollTimeout;
                    window.addEventListener('scroll', () => {
                        clearTimeout(scrollTimeout);
                        scrollTimeout = setTimeout(updateActiveOnScroll, SCROLL_THROTTLE_MS);
                    });

                    // Mobile TOC toggle functionality
                    if (tocToggle) {
                        tocToggle.addEventListener('click', () => {
                            const isCollapsed = toc.classList.contains('collapsed');
                            if (isCollapsed) {
                                toc.classList.remove('collapsed');
                                updateToggleButton(false);
                            } else {
                                toc.classList.add('collapsed');
                                updateToggleButton(true);
                            }
                        });
                    }
                } else {
                    // Hide TOC if no headings
                    toc.style.display = 'none';
                    if (tocToggle) tocToggle.style.display = 'none';
                }
            }

            if (window.location.hostname !== 'localhost') {
                return;
            }
            // Live reload script
            const port = window.location.port || (window.location.protocol === 'https:' ? '443' : '80');
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const socketUrl = `${protocol}//${window.location.hostname}:${port}/ws`;
            let socket;

            function connect() {
                socket = new WebSocket(socketUrl);
                socket.addEventListener('open', () => { console.log('Live reload connected.'); });
                socket.addEventListener('message', (event) => {
                    if (event.data === 'reload') {
                        console.log('Reloading page...');
                        window.location.reload();
                    }
                });
                socket.addEventListener('close', () => {
                    console.log('Live reload disconnected. Trying to reconnect in 2 seconds...');
                    setTimeout(connect, 2000);
                });
                socket.addEventListener('error', (err) => {
                    console.error('Live reload error:', err);
                    socket.close();
                });
            }
            connect();
        })();
    </script>
</body>
</html>
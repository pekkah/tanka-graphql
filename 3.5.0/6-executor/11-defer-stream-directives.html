<!DOCTYPE html>
<html lang="en">

<head>
    <base href="/tanka-graphql/">
    <title>11-defer-stream-directives - Tanka GraphQL</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    
    <!-- Noto Color Emoji font for cross-platform emoji support -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&display=swap" rel="stylesheet">
    
    <!-- Highlight.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">

    <style>
        :root {
            --bs-body-font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", sans-serif;
            --bs-link-color-rgb: 8, 87, 168;
            --bs-link-hover-color-rgb: 6, 68, 130;
        }

        body {
            font-family: var(--bs-body-font-family);
        }

        .sidebar {
            position: sticky;
            top: 56px; /* Height of navbar */
            height: calc(100vh - 56px);
            overflow-y: auto;
            background-color: #f8f9fa;
            border-right: 1px solid #dee2e6;
            padding-top: 1rem;
        }

        /* Mobile sidebar improvements */
        @media (max-width: 767.98px) {
            .sidebar {
                position: fixed;
                top: 56px;
                left: 0;
                width: 100%;
                height: calc(100vh - 56px);
                z-index: 1040;
                border-right: none;
                border-bottom: 1px solid #dee2e6;
            }
            
            .sidebar.collapse:not(.show) {
                display: none;
            }
            
            .sidebar.collapsing,
            .sidebar.collapse.show {
                display: block;
            }
        }

        .toc-sidebar {
            position: sticky;
            top: 56px; /* Height of navbar */
            height: calc(100vh - 56px);
            overflow-y: auto;
            padding-top: 1rem;
        }

        /* Mobile TOC styling - single responsive TOC */
        @media (max-width: 991.98px) {
            .toc-sidebar {
                position: static !important;
                height: auto !important;
                max-height: 300px;
                overflow-y: auto;
                background-color: #f8f9fa;
                border: 1px solid #dee2e6;
                border-radius: 0.375rem;
                margin-bottom: 1rem;
                padding: 1rem;
                /* Move TOC to mobile position - above content */
                order: -1;
                display: block !important; /* Override Bootstrap d-none d-lg-block */
            }

            .toc-sidebar.collapsed {
                display: none !important;
            }

            .toc-sidebar .toc-title {
                display: none; /* Hide desktop title on mobile */
            }

            /* Adjust main content layout for mobile */
            .content {
                order: 0;
            }
        }

        .toc-toggle {
            display: none;
        }

        @media (max-width: 991.98px) {
            .toc-toggle {
                display: inline-block;
            }
        }

        .sidebar .nav-link {
            font-size: 0.9rem;
            color: #495057;
        }

        .sidebar .nav-link.active, .sidebar .nav-link:hover {
            color: rgb(var(--bs-link-color-rgb));
            font-weight: 500;
        }

        /* Ensure emojis render properly in navigation */
        .sidebar .nav-link {
            font-feature-settings: "liga" on, "clig" on;
            text-rendering: optimizeLegibility;
            font-family: var(--bs-body-font-family);
        }
        
        .toc-sidebar .nav-link {
            font-size: 0.8rem;
            color: #6c757d;
            padding-top: 0.25rem;
            padding-bottom: 0.25rem;
        }

        .toc-sidebar .nav-link:hover {
            color: #212529;
        }

        .toc-sidebar .nav-link.active {
            font-weight: 600;
            color: #212529; /* Darker text for readability */
            border-left: 2px solid rgb(var(--bs-link-color-rgb));
        }

        blockquote {
            font-size: 1rem;
            border-left: 4px solid #adb5bd;
            padding-left: 1rem;
            color: #6c757d;
        }

        .content h1, .content h2, .content h3, .content h4, .content h5, .content h6 {
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }

        .content h2, .content h3 {
            scroll-margin-top: 80px;
        }

        /* Adjust code block styling to match highlight.js theme */
        pre code.hljs {
            border-radius: 0.3rem;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Tanka GraphQL</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a class="nav-link" href="3.5.0/index.html">Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="3.5.0/0-getting-started/00-getting-started.html">Getting Started</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="3.5.0/10-extensions/tracing.html">Extensions</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="3.5.0/2-language/01-parser.html">Language</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="3.5.0/3-server/00-index.html">Server</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="3.5.0/4-code-generator/01-samples-sg-basic.html">Code Generation</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="3.5.0/6-executor/01-executor.html">Executor</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="3.5.0/7-type-system/02-schema.html">Type System</a>
                        </li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="https://github.com/pekkah/tanka-graphql" target="_blank" rel="noopener">GitHub</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            3.5.0
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownMenuLink">
                                <li><a class="dropdown-item" href="/tanka-graphql/main">main</a></li>
                                <li><a class="dropdown-item" href="/tanka-graphql/3.5.0">3.5.0</a></li>
                                <li><a class="dropdown-item" href="/tanka-graphql/3.0.0">3.0.0</a></li>
                                <li><a class="dropdown-item" href="/tanka-graphql/2.0.1">2.0.1</a></li>
                                <li><a class="dropdown-item" href="/tanka-graphql/2.0.0">2.0.0</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container-fluid">
        <div class="row">
            <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
    <nav class="nav flex-column">
<li class="nav-item">
    <div class="d-flex justify-content-between align-items-center">
        <a class="nav-link" href=3.5.0/6-executor/01-executor.html>Executor</a>
        <a class="btn btn-sm" data-bs-toggle="collapse" href="#nav-01-executor.md" role="button" aria-expanded="false" aria-controls="nav-01-executor.md">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>
        </a>
    </div>
    <div class="collapse" id="nav-01-executor.md">
        <ul class="nav flex-column ms-3">
<li class="nav-item">
    <div class="d-flex justify-content-between align-items-center">
        <a class="nav-link" href=3.5.0/6-executor/02-simple-usage.html>Simple Usage</a>
    </div>
</li><li class="nav-item">
    <div class="d-flex justify-content-between align-items-center">
        <a class="nav-link" href=3.5.0/6-executor/03-queries-and-mutations.html>Queries and mutations</a>
    </div>
</li><li class="nav-item">
    <div class="d-flex justify-content-between align-items-center">
        <a class="nav-link" href=3.5.0/6-executor/04-subscriptions.html>Subscriptions</a>
    </div>
</li>        </ul>
    </div>
</li>    </nav>
    <nav class="nav flex-column">
<li class="nav-item">
    <div class="d-flex justify-content-between align-items-center">
        <a class="nav-link" href=3.5.0/6-executor/05-pipeline.html>Pipeline</a>
        <a class="btn btn-sm" data-bs-toggle="collapse" href="#nav-05-pipeline.md" role="button" aria-expanded="false" aria-controls="nav-05-pipeline.md">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>
        </a>
    </div>
    <div class="collapse" id="nav-05-pipeline.md">
        <ul class="nav flex-column ms-3">
<li class="nav-item">
    <div class="d-flex justify-content-between align-items-center">
        <a class="nav-link" href=3.5.0/6-executor/06-pipeline-operation.html>Operation</a>
    </div>
</li><li class="nav-item">
    <div class="d-flex justify-content-between align-items-center">
        <a class="nav-link" href=3.5.0/6-executor/07-pipeline-selection-sets.html>SelectionSet</a>
    </div>
</li><li class="nav-item">
    <div class="d-flex justify-content-between align-items-center">
        <a class="nav-link" href=3.5.0/6-executor/08-pipeline-fields.html>Fields</a>
    </div>
</li><li class="nav-item">
    <div class="d-flex justify-content-between align-items-center">
        <a class="nav-link" href=3.5.0/6-executor/09-pipeline-resolvers.html>Resolver</a>
    </div>
</li><li class="nav-item">
    <div class="d-flex justify-content-between align-items-center">
        <a class="nav-link" href=3.5.0/6-executor/10-pipeline-subscribers.html>Subscriber</a>
    </div>
</li>        </ul>
    </div>
</li>    </nav>
    <nav class="nav flex-column">
<li class="nav-item">
    <div class="d-flex justify-content-between align-items-center">
        <a class="nav-link" href=3.5.0/6-executor/11-defer-stream-directives.html>@defer and @stream Directives</a>
    </div>
</li>    </nav>
            </nav>
            <main class="col-md-6 ms-sm-auto col-lg-7 px-md-4 py-3 content d-flex flex-column">
                <!-- Mobile navigation buttons -->
                <div class="d-md-none mb-3">
                    <button id="sidebar-toggle" class="btn btn-outline-primary btn-sm me-2" type="button" data-bs-toggle="collapse" data-bs-target="#sidebar" aria-expanded="false" aria-controls="sidebar">
                        <svg width="16" height="16" fill="currentColor" class="bi bi-list" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/>
                        </svg>
                        <span class="ms-1">Menu</span>
                    </button>
                    <button id="toc-toggle" class="btn btn-outline-secondary btn-sm toc-toggle" type="button">
                        <svg width="16" height="16" fill="currentColor" class="bi bi-list" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/>
                        </svg>
                        <span class="ms-1">On this page</span>
                    </button>
                </div>
                <h1 id="defer-and-stream-directives-usage-guide">@defer and @stream Directives Usage Guide</h1>
<p>This guide covers the practical usage of <code>@defer</code> and <code>@stream</code> directives in Tanka GraphQL for incremental delivery.</p>
<h2 id="server-configuration">Server Configuration</h2>
<h3 id="service-registration">Service Registration</h3>
<p><strong>Full Incremental Delivery Support</strong></p>
<pre><code class="language-csharp">services.AddDefaultTankaGraphQLServices();
services.AddIncrementalDeliveryDirectives(); // Adds both @defer and @stream
</code></pre>
<p><strong>Individual Directive Support</strong></p>
<pre><code class="language-csharp">services.AddDefaultTankaGraphQLServices();
services.AddDeferDirective();   // Only @defer directive
services.AddStreamDirective();  // Only @stream directive
</code></pre>
<h3 id="schema-configuration">Schema Configuration</h3>
<p><strong>Executable Schema Builder</strong></p>
<pre><code class="language-csharp">var schema = await new ExecutableSchemaBuilder()
    .AddIncrementalDeliveryDirectives() // Registers both directives
    .Add(&quot;Query&quot;, queryResolvers)
    .Build();
</code></pre>
<p><strong>Manual Registration</strong></p>
<pre><code class="language-csharp">var schema = await new ExecutableSchemaBuilder()
    .AddDeferDirective()
    .AddStreamDirective()
    .Add(&quot;Query&quot;, queryResolvers)
    .Build();
</code></pre>
<h2 id="defer-directive-usage">@defer Directive Usage</h2>
<p>For a complete, working example of @defer usage, see: <a href="https://github.com/pekkah/tanka-graphql/blob/main/tutorials/GraphQL.Tutorials.Getting-Started/DeferStreamTutorials.cs">Defer Tutorial Basic Usage</a></p>
<h3 id="syntax-variations">Syntax Variations</h3>
<p><strong>Basic Defer</strong></p>
<pre><code class="language-graphql">{
  user {
    id
    name
    ... @defer {
      profile {
        bio
        avatar
      }
    }
  }
}
</code></pre>
<p><strong>Labeled Defer</strong></p>
<pre><code class="language-graphql">{
  user {
    id
    name
    ... @defer(label: &quot;userProfile&quot;) {
      profile {
        bio
        avatar
      }
    }
  }
}
</code></pre>
<p><strong>Variable Labels</strong></p>
<pre><code class="language-graphql">query GetUser($profileLabel: String!) {
  user {
    id
    name
    ... @defer(label: $profileLabel) {
      profile {
        bio
        avatar
      }
    }
  }
}
</code></pre>
<h3 id="multiple-deferred-fragments">Multiple Deferred Fragments</h3>
<pre><code class="language-graphql">{
  user {
    id
    name

    ... @defer(label: &quot;profile&quot;) {
      profile {
        bio
        avatar
      }
    }

    ... @defer(label: &quot;posts&quot;) {
      posts {
        title
        content
      }
    }

    ... @defer(label: &quot;friends&quot;) {
      friends {
        id
        name
      }
    }
  }
}
</code></pre>
<h3 id="nested-defer">Nested Defer</h3>
<pre><code class="language-graphql">{
  user {
    id
    name

    ... @defer(label: &quot;level1&quot;) {
      profile {
        bio

        ... @defer(label: &quot;level2&quot;) {
          settings {
            theme
            notifications
          }
        }
      }
    }
  }
}
</code></pre>
<h2 id="stream-directive-usage">@stream Directive Usage</h2>
<p>For a complete, working example of @stream usage, see: <a href="https://github.com/pekkah/tanka-graphql/blob/main/tutorials/GraphQL.Tutorials.Getting-Started/DeferStreamTutorials.cs">Stream Tutorial Basic Usage</a></p>
<h3 id="syntax-variations-1">Syntax Variations</h3>
<p><strong>Basic Stream</strong></p>
<pre><code class="language-graphql">{
  products @stream {
    id
    name
    price
  }
}
</code></pre>
<p><strong>With Initial Count</strong></p>
<pre><code class="language-graphql">{
  products @stream(initialCount: 3) {
    id
    name
    price
    description
  }
}
</code></pre>
<p><strong>Stream All Items</strong></p>
<pre><code class="language-graphql">{
  products @stream(initialCount: 0) {
    id
    name
    price
  }
}
</code></pre>
<p><strong>Labeled Stream</strong></p>
<pre><code class="language-graphql">{
  products @stream(initialCount: 2, label: &quot;productList&quot;) {
    id
    name
    price
  }
}
</code></pre>
<h3 id="stream-with-nested-data">Stream with Nested Data</h3>
<pre><code class="language-graphql">{
  categories @stream(initialCount: 1) {
    id
    name
    products {
      id
      name
      price
    }
  }
}
</code></pre>
<h3 id="conditional-streaming">Conditional Streaming</h3>
<pre><code class="language-graphql">query GetProducts($shouldStream: Boolean = false, $initialCount: Int = 5) {
  products @stream(initialCount: $initialCount) @skip(if: $shouldStream) {
    id
    name
    price
  }

  # Fallback for non-streaming
  allProducts: products @include(if: $shouldStream) {
    id
    name
    price
  }
}
</code></pre>
<h2 id="combined-usage-patterns">Combined Usage Patterns</h2>
<h3 id="defer-stream-together">Defer + Stream Together</h3>
<p>For a complete example combining both directives, see: <a href="https://github.com/pekkah/tanka-graphql/blob/main/tutorials/GraphQL.Tutorials.Getting-Started/DeferStreamTutorials.cs">Combined Defer and Stream Tutorial</a></p>
<pre><code class="language-graphql">{
  user {
    id
    name

    ... @defer(label: &quot;posts&quot;) {
      posts @stream(initialCount: 3) {
        id
        title
        content

        ... @defer(label: &quot;postStats&quot;) {
          likes
          comments
          shares
        }
      }
    }
  }
}
</code></pre>
<h3 id="complex-data-hierarchies">Complex Data Hierarchies</h3>
<pre><code class="language-graphql">{
  dashboard {
    # Critical data first
    user {
      id
      name
    }

    # Analytics deferred
    ... @defer(label: &quot;analytics&quot;) {
      analytics {
        totalViews

        # Large datasets streamed
        topPages @stream(initialCount: 5) {
          url
          views

          # Expensive metrics deferred per item
          ... @defer(label: &quot;pageMetrics&quot;) {
            bounceRate
            timeOnPage
            conversions
          }
        }
      }
    }

    # Recent activity streamed
    ... @defer(label: &quot;activity&quot;) {
      recentActivity @stream(initialCount: 2) {
        id
        type
        timestamp
        description
      }
    }
  }
}
</code></pre>
<h2 id="field-resolution-patterns">Field Resolution Patterns</h2>
<h3 id="proper-resolver-implementation">Proper Resolver Implementation</h3>
<p><strong>Collection Resolvers for @stream</strong></p>
<pre><code class="language-csharp">// ✅ Correct: Return actual collection
.Add(&quot;products: [Product]&quot;, b =&gt; b.ResolveAs(productList))

// ❌ Incorrect: Returns function instead of collection
.Add(&quot;products: [Product]&quot;, b =&gt; b.ResolveAs(() =&gt; productList))
</code></pre>
<p><strong>Async Resolvers for @defer</strong></p>
<pre><code class="language-csharp">.Add(&quot;User&quot;, new()
{
    { &quot;id: ID!&quot;, b =&gt; b.ResolveAsPropertyOf&lt;User&gt;(u =&gt; u.Id) },
    { &quot;name: String!&quot;, b =&gt; b.ResolveAsPropertyOf&lt;User&gt;(u =&gt; u.Name) },
    {
        &quot;profile: Profile&quot;,
        async context =&gt;
        {
            // Expensive operation suitable for deferring
            await Task.Delay(100);
            var profile = await profileService.GetProfileAsync(context.Parent&lt;User&gt;().Id);
            context.ResolvedValue = profile;
        }
    }
})
</code></pre>
<h2 id="response-structure-examples">Response Structure Examples</h2>
<h3 id="defer-response-flow">@defer Response Flow</h3>
<p><strong>Initial Response</strong></p>
<pre><code class="language-json">{
  &quot;data&quot;: {
    &quot;user&quot;: {
      &quot;id&quot;: &quot;1&quot;,
      &quot;name&quot;: &quot;John Doe&quot;
    }
  },
  &quot;hasNext&quot;: true
}
</code></pre>
<p><strong>Incremental Response</strong></p>
<pre><code class="language-json">{
  &quot;incremental&quot;: [
    {
      &quot;label&quot;: &quot;userProfile&quot;,
      &quot;path&quot;: [&quot;user&quot;],
      &quot;data&quot;: {
        &quot;profile&quot;: {
          &quot;bio&quot;: &quot;Software developer&quot;,
          &quot;avatar&quot;: &quot;https://example.com/avatar.jpg&quot;
        }
      }
    }
  ],
  &quot;hasNext&quot;: false
}
</code></pre>
<h3 id="stream-response-flow">@stream Response Flow</h3>
<p><strong>Initial Response</strong></p>
<pre><code class="language-json">{
  &quot;data&quot;: {
    &quot;products&quot;: [
      {&quot;id&quot;: &quot;1&quot;, &quot;name&quot;: &quot;Product 1&quot;, &quot;price&quot;: 100},
      {&quot;id&quot;: &quot;2&quot;, &quot;name&quot;: &quot;Product 2&quot;, &quot;price&quot;: 200}
    ]
  },
  &quot;hasNext&quot;: true
}
</code></pre>
<p><strong>Incremental Responses</strong></p>
<pre><code class="language-json">{
  &quot;incremental&quot;: [
    {
      &quot;path&quot;: [&quot;products&quot;],
      &quot;items&quot;: [
        {&quot;id&quot;: &quot;3&quot;, &quot;name&quot;: &quot;Product 3&quot;, &quot;price&quot;: 300}
      ]
    }
  ],
  &quot;hasNext&quot;: true
}
</code></pre>
<pre><code class="language-json">{
  &quot;incremental&quot;: [
    {
      &quot;path&quot;: [&quot;products&quot;],
      &quot;items&quot;: [
        {&quot;id&quot;: &quot;4&quot;, &quot;name&quot;: &quot;Product 4&quot;, &quot;price&quot;: 400},
        {&quot;id&quot;: &quot;5&quot;, &quot;name&quot;: &quot;Product 5&quot;, &quot;price&quot;: 500}
      ]
    }
  ],
  &quot;hasNext&quot;: false
}
</code></pre>
<h2 id="error-handling">Error Handling</h2>
<h3 id="partial-errors-in-deferred-data">Partial Errors in Deferred Data</h3>
<pre><code class="language-json">{
  &quot;incremental&quot;: [
    {
      &quot;label&quot;: &quot;userProfile&quot;,
      &quot;path&quot;: [&quot;user&quot;],
      &quot;data&quot;: {
        &quot;profile&quot;: null
      },
      &quot;errors&quot;: [
        {
          &quot;message&quot;: &quot;Profile service unavailable&quot;,
          &quot;path&quot;: [&quot;user&quot;, &quot;profile&quot;]
        }
      ]
    }
  ],
  &quot;hasNext&quot;: false
}
</code></pre>
<h3 id="stream-item-errors">Stream Item Errors</h3>
<pre><code class="language-json">{
  &quot;incremental&quot;: [
    {
      &quot;path&quot;: [&quot;products&quot;],
      &quot;items&quot;: [null, null, {&quot;id&quot;: &quot;3&quot;, &quot;name&quot;: &quot;Product 3&quot;, &quot;price&quot;: 300}],
      &quot;errors&quot;: [
        {
          &quot;message&quot;: &quot;Product not found&quot;,
          &quot;path&quot;: [&quot;products&quot;, 0]
        },
        {
          &quot;message&quot;: &quot;Access denied&quot;,
          &quot;path&quot;: [&quot;products&quot;, 1]
        }
      ]
    }
  ],
  &quot;hasNext&quot;: true
}
</code></pre>
<h2 id="performance-optimization">Performance Optimization</h2>
<h3 id="batching-strategies">Batching Strategies</h3>
<ul>
<li>Group related deferred fields under single labels</li>
<li>Use appropriate <code>initialCount</code> values for streams</li>
<li>Consider network round-trip costs vs. data size</li>
</ul>
<h3 id="memory-management">Memory Management</h3>
<ul>
<li>Stream large datasets instead of loading everything</li>
<li>Use defer for expensive computations</li>
<li>Monitor server memory usage during streaming</li>
</ul>
<h3 id="caching-considerations">Caching Considerations</h3>
<ul>
<li>Incremental responses complicate caching</li>
<li>Consider caching strategies for initial vs. deferred data</li>
<li>Use labels consistently for cache key generation</li>
</ul>
<h2 id="testing-strategies">Testing Strategies</h2>
<h3 id="unit-testing-resolvers">Unit Testing Resolvers</h3>
<p>Complete unit tests can be found in:</p>
<ul>
<li><a href="https://github.com/pekkah/tanka-graphql/blob/main/tests/GraphQL.Tests/SelectionSets/StreamDirectiveExecutionTests.cs">StreamDirectiveExecutionTests.cs</a></li>
</ul>
<h3 id="integration-testing">Integration Testing</h3>
<p>Complete integration tests can be found in:</p>
<ul>
<li><a href="https://github.com/pekkah/tanka-graphql/blob/main/tests/GraphQL.Tests/DeferStreamIntegrationFacts.cs">DeferStreamIntegrationFacts.cs</a></li>
</ul>
<h3 id="manual-testing-commands">Manual Testing Commands</h3>
<p><strong>Test @defer</strong></p>
<pre><code class="language-bash">curl -X POST http://localhost:5000/graphql \
  -H &quot;Content-Type: application/json&quot; \
  -H &quot;Accept: multipart/mixed&quot; \
  -d '{&quot;query&quot;: &quot;{ user { id name ... @defer(label: \&quot;profile\&quot;) { profile { email } } } }&quot;}'
</code></pre>
<p><strong>Test @stream</strong></p>
<pre><code class="language-bash">curl -X POST http://localhost:5000/graphql \
  -H &quot;Content-Type: application/json&quot; \
  -H &quot;Accept: multipart/mixed&quot; \
  -d '{&quot;query&quot;: &quot;{ products @stream(initialCount: 2) { id name } }&quot;}'
</code></pre>

            </main>
            <!-- Single responsive TOC -->
            <nav id="toc" class="col-md-3 col-lg-3 d-none d-lg-block toc-sidebar collapsed">
                <strong class="d-block h6 my-2 pb-2 border-bottom toc-title">On this page</strong>
                <nav class="nav flex-column"></nav>
            </nav>
        </div>
    </div>
    
    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    
    <!-- Highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>

    <script>
        (function() {

            // Left sidebar active link and mobile navigation
            const sidebar = document.querySelector('.sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const MOBILE_BREAKPOINT = 768;
            
            if (sidebar) {
                const baseHref = document.baseURI;
                const currentPageHref = window.location.href.split('#')[0]; // Ignore hash
                let currentPagePath = currentPageHref.substring(baseHref.length);

                if (currentPagePath.endsWith('/')) {
                    currentPagePath = currentPagePath.slice(0, -1);
                }

                const navLinks = sidebar.querySelectorAll('a.nav-link');
                navLinks.forEach(link => {
                    const linkHref = link.getAttribute('href');
                    if (linkHref && (linkHref === currentPagePath || linkHref === currentPagePath + '/index.html')) {
                        link.classList.add('active');

                        let parentCollapse = link.closest('.collapse');
                        while(parentCollapse) {
                            parentCollapse.classList.add('show');
                            const trigger = document.querySelector(`a[data-bs-toggle="collapse"][href="#${parentCollapse.id}"]`);
                            if (trigger) {
                                trigger.setAttribute('aria-expanded', 'true');
                                trigger.classList.remove('collapsed');
                            }
                            parentCollapse = parentCollapse.parentElement.closest('.collapse');
                        }
                    }
                    
                    // Auto-close sidebar on mobile when navigation link is clicked
                    link.addEventListener('click', () => {
                        if (window.innerWidth < MOBILE_BREAKPOINT && sidebar.classList.contains('show')) {
                            const bsCollapse = new bootstrap.Collapse(sidebar, {
                                toggle: false
                            });
                            bsCollapse.hide();
                        }
                    });
                });
            }

            // "On this page" TOC script - single responsive TOC
            const toc = document.getElementById('toc');
            const tocToggle = document.getElementById('toc-toggle');
            
            // Constants
            const SCROLL_OFFSET = 100;
            const SCROLL_THROTTLE_MS = 25; // Optimized from 10ms
            const SCROLL_NAVIGATION_TIMEOUT_MS = 200;
            const MOBILE_BREAKPOINT = 992;
            
            if (toc) {
                const mainContent = document.querySelector('.content');
                if (!mainContent) return;
                
                const headings = mainContent.querySelectorAll('h2, h3');
                const tocNav = toc.querySelector('.nav');
                
                if (!tocNav) return;
                
                if (headings.length > 0) {
                    let isScrolling = false;
                    
                    // Create TOC links
                    headings.forEach((heading, index) => {
                        const id = 'heading-' + index;
                        if (!heading.getAttribute('id')) {
                            heading.setAttribute('id', id);
                        }

                        const link = document.createElement('a');
                        link.classList.add('nav-link');
                        if (heading.tagName === 'H3') {
                            link.classList.add('ms-3'); // Indent H3
                        }
                        
                        const href = '#' + id;
                        link.setAttribute('href', href);
                        link.textContent = heading.textContent;

                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            
                            // Temporarily disable scroll tracking during navigation
                            isScrolling = true;
                            
                            // Remove active class from all TOC links
                            tocNav.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                            
                            // Add active class to clicked link
                            link.classList.add('active');
                            
                            // On mobile, collapse the TOC after clicking a link
                            if (window.innerWidth < MOBILE_BREAKPOINT && toc) {
                                toc.classList.add('collapsed');
                                if (tocToggle) {
                                    updateToggleButton(true);
                                }
                            }
                            
                            // Navigate to the hash
                            window.location.hash = href;
                            
                            // Re-enable scroll tracking after navigation completes
                            let scrollTimeout;
                            const handleScroll = () => {
                                clearTimeout(scrollTimeout);
                                scrollTimeout = setTimeout(() => {
                                    window.removeEventListener('scroll', handleScroll);
                                    isScrolling = false;
                                }, SCROLL_NAVIGATION_TIMEOUT_MS);
                            };
                            
                            window.addEventListener('scroll', handleScroll);
                            
                            // Fallback: re-enable after 1 second
                            setTimeout(() => {
                                window.removeEventListener('scroll', handleScroll);
                                isScrolling = false;
                            }, 1000);
                        });
                        
                        tocNav.appendChild(link);
                    });

                    // Update toggle button appearance
                    const updateToggleButton = (isCollapsed) => {
                        if (!tocToggle) return;
                        
                        if (isCollapsed) {
                            tocToggle.innerHTML = `<svg width="16" height="16" fill="currentColor" class="bi bi-list" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/>
                            </svg><span class="ms-1">On this page</span>`;
                        } else {
                            tocToggle.innerHTML = `<svg width="16" height="16" fill="currentColor" class="bi bi-chevron-up" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M7.646 4.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1-.708.708L8 5.707l-5.646 5.647a.5.5 0 0 1-.708-.708l6-6z"/>
                            </svg><span class="ms-1">Hide</span>`;
                        }
                    };

                    // Set initial active state based on current scroll position or hash
                    const setInitialActiveState = () => {
                        const hash = window.location.hash;
                        if (hash && tocNav) {
                            const targetLink = tocNav.querySelector(`a[href="${hash}"]`);
                            if (targetLink) {
                                tocNav.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                                targetLink.classList.add('active');
                                return;
                            }
                        }
                        
                        // Find the currently visible heading
                        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                        let activeHeading = null;
                        
                        for (let i = 0; i < headings.length; i++) {
                            const heading = headings[i];
                            const rect = heading.getBoundingClientRect();
                            const headingTop = rect.top + scrollTop;
                            
                            if (headingTop <= scrollTop + SCROLL_OFFSET) {
                                activeHeading = heading;
                            } else {
                                break;
                            }
                        }
                        
                        if (activeHeading && tocNav) {
                            const activeId = activeHeading.getAttribute('id');
                            const activeLink = tocNav.querySelector(`a[href="#${activeId}"]`);
                            if (activeLink) {
                                tocNav.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                                activeLink.classList.add('active');
                            }
                        } else if (tocNav) {
                            // If no heading is visible, activate the first one
                            const firstLink = tocNav.querySelector('.nav-link');
                            if (firstLink) {
                                firstLink.classList.add('active');
                            }
                        }
                    };

                    // Set initial active state
                    setInitialActiveState();

                    // Optimized scroll tracking
                    const updateActiveOnScroll = () => {
                        if (isScrolling || !tocNav) return;
                        
                        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                        let activeHeading = null;
                        
                        for (let i = 0; i < headings.length; i++) {
                            const heading = headings[i];
                            const rect = heading.getBoundingClientRect();
                            const headingTop = rect.top + scrollTop;
                            
                            if (headingTop <= scrollTop + SCROLL_OFFSET) {
                                activeHeading = heading;
                            } else {
                                break;
                            }
                        }
                        
                        const currentActiveLink = tocNav.querySelector('.nav-link.active');
                        let newActiveLink = null;
                        
                        if (activeHeading) {
                            const activeId = activeHeading.getAttribute('id');
                            newActiveLink = tocNav.querySelector(`a[href="#${activeId}"]`);
                        } else {
                            newActiveLink = tocNav.querySelector('.nav-link');
                        }
                        
                        if (newActiveLink && newActiveLink !== currentActiveLink) {
                            tocNav.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                            newActiveLink.classList.add('active');
                        }
                    };
                    
                    // Throttled scroll listener
                    let scrollTimeout;
                    window.addEventListener('scroll', () => {
                        clearTimeout(scrollTimeout);
                        scrollTimeout = setTimeout(updateActiveOnScroll, SCROLL_THROTTLE_MS);
                    });

                    // Mobile TOC toggle functionality
                    if (tocToggle) {
                        tocToggle.addEventListener('click', () => {
                            const isCollapsed = toc.classList.contains('collapsed');
                            if (isCollapsed) {
                                toc.classList.remove('collapsed');
                                updateToggleButton(false);
                            } else {
                                toc.classList.add('collapsed');
                                updateToggleButton(true);
                            }
                        });
                    }
                } else {
                    // Hide TOC if no headings
                    toc.style.display = 'none';
                    if (tocToggle) tocToggle.style.display = 'none';
                }
            }

            if (window.location.hostname !== 'localhost') {
                return;
            }
            // Live reload script
            const port = window.location.port || (window.location.protocol === 'https:' ? '443' : '80');
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const socketUrl = `${protocol}//${window.location.hostname}:${port}/ws`;
            let socket;

            function connect() {
                socket = new WebSocket(socketUrl);
                socket.addEventListener('open', () => { console.log('Live reload connected.'); });
                socket.addEventListener('message', (event) => {
                    if (event.data === 'reload') {
                        console.log('Reloading page...');
                        window.location.reload();
                    }
                });
                socket.addEventListener('close', () => {
                    console.log('Live reload disconnected. Trying to reconnect in 2 seconds...');
                    setTimeout(connect, 2000);
                });
                socket.addEventListener('error', (err) => {
                    console.error('Live reload error:', err);
                    socket.close();
                });
            }
            connect();
        })();
    </script>
</body>
</html>
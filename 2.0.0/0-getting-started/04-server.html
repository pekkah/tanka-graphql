<!DOCTYPE html>
<html lang="en">

<head>
    <base href="/tanka-graphql/">
    <title>04-server - Tanka GraphQL</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <link rel="stylesheet" href="2.0.0/prism.css" />
    <style>
        body {
            height: 100%;
            width: 100%;         
        }

        a {
            color: rgba(0,0,0,.65);
        }

        a:hover {
            color: rgba(8, 8, 8, 0.65);
        }

        blockquote {
            border: 1px solid rgba(94, 94, 94, 0.65);
            border-left: 5px solid rgba(94, 94, 94, 0.65);
            padding: 0.75rem 1.5rem;
            margin-top: 1rem;
            margin-bottom: 1rem;            
        }

        .sidebar {
            margin-bottom: 20px;
        }

        .sidebar .nav-item {
            list-style: none;
        }

        .sidebar .nav-link {
            display: block;
            padding: .25rem 1.5rem;
            font-size: 90%;
            color: rgba(0,0,0,.65);
        }

        .sidebar .nav-link:hover {
            text-decoration: underline;
        }

        .content h1,
        .content h2,
        .content h3,
        .content h4,
        .content h5,
        .content h6 {
            font-weight: 300;
        }

        
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="#">Tanka GraphQL</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto">
                <li class="nav-item">
                    <a class="nav-link" href="2.0.0/0-getting-started/01-create-schema.html">Getting Started</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="2.0.0/0-language/01-parser.html">Language</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="2.0.0/1-execution/01-resolvers.html">Execution</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="2.0.0/2-server/0-common.html">Server</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="2.0.0/3-code-generator/1-installation.html">Code Generation</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="2.0.0/7-type-system/02-schema.html">Type System</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="2.0.0/10-extensions/tracing.html">Extensions</a>
                </li>
        </ul>
        <ul class="navbar-nav ml-auto">
             <li class="nav-item">
                <a class="nav-link" href="https://github.com/pekkah/tanka-graphql">GitHub</a>
            </li>
            <li class="nav-item dropdown justify-content-end">
                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    2.0.0
                </a>
                <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                        <a class="dropdown-item" href="/tanka-graphql/2.0.1">2.0.1</a>
                        <a class="dropdown-item" href="/tanka-graphql/master">master</a>
                        <a class="dropdown-item" href="/tanka-graphql/2.0.0">2.0.0</a>
                </div>
            </li>
        </ul>
        </div>
    </nav>
    <div class="container-fluid">
        <div class="row flex-xl-nowrap">
            <nav class="col-12 col-md-3 col-xl-2 sidebar">
                <div class="sidebar-sticky">
    <nav class="nav flex-column">
<li class="nav-item">
    <a class="nav-link" href=2.0.0/index.html>Home</a>
    <ul>
    </ul>
</li>    </nav>
    <nav class="nav flex-column">
<li class="nav-item">
    <a class="nav-link" href=2.0.0/0-getting-started/01-create-schema.html>Getting started</a>
    <ul>
<li class="nav-item">
    <a class="nav-link" href=2.0.0/0-getting-started/01-create-schema.html>Create schema</a>
    <ul>
    </ul>
</li><li class="nav-item">
    <a class="nav-link" href=2.0.0/0-getting-started/02-bind-resolvers.html>Bind resolvers</a>
    <ul>
    </ul>
</li><li class="nav-item">
    <a class="nav-link" href=2.0.0/0-getting-started/03-apply-directives.html>Apply directives</a>
    <ul>
    </ul>
</li><li class="nav-item">
    <a class="nav-link" href=2.0.0/0-getting-started/04-server.html>Server</a>
    <ul>
    </ul>
</li><li class="nav-item">
    <a class="nav-link" href=2.0.0/0-getting-started/05-dependency-injection.html>Depedency Injection</a>
    <ul>
    </ul>
</li><li class="nav-item">
    <a class="nav-link" href=2.0.0/0-getting-started/06-custom-scalars.html>Custom Scalars</a>
    <ul>
    </ul>
</li>    </ul>
</li>    </nav>
                </div>
            </nav>
            <main role="main" class="col-12 col-md-8 col-xl-6 py-sm-1 py-md-3 pl-md-5 content">
                <h2 id="server">Server</h2>
<p>Tanka provides server components in <code>Tanka.GraphQL.server</code> NuGet
package. It can be used to get up and running or if more control is
required then you can implement your own server.</p>
<blockquote class="blockquote">
<p>See also</p>
<ul>
<li><a href="2.0.0/2-server/0-common.html">Server</a></li>
</ul>
</blockquote>
<p>Tanka Server provides two server components which can be used together
or separately.</p>
<ul>
<li>SignalR - server built on top of SignalR Core</li>
<li>GraphQL-WS - custom WebSockets server supporting <code>graphql-ws</code> messages</li>
</ul>
<p>Following steps are required to get the server running with your schema.</p>
<ol>
<li>Build schema</li>
<li>Configure schema options</li>
<li>Configure server</li>
<li>HTTP API</li>
</ol>
<h3 id="build-schema">1. Build schema</h3>
<p>First step for either server is to configure your schema options
for execution. Schema should be built only once and cached as singleton.</p>
<pre><code class="language-csharp">
        private async Task&lt;ISchema&gt; Create()
        {
            // Do some async work to build the schema. For example
            // load SDL from file
            await Task.Delay(0);

            // Build simple schema from SDL string
            var builder = new SchemaBuilder()
                .Sdl(
                    @&quot;
                    type Query {
                        firstName: String!
                        lastName: String!
                    }

                    schema {
                        query: Query
                    }
                    &quot;);

            // Bind resolvers and build
            return SchemaTools
                .MakeExecutableSchemaWithIntrospection(
                    builder,
                    new ObjectTypeMap
                    {
                        [&quot;Query&quot;] = new FieldResolversMap
                        {
                            {&quot;firstName&quot;, context =&gt; ResolveSync.As(&quot;Tanka&quot;)},
                            {&quot;lastName&quot;, UseService()}
                        }
                    });
        }

</code></pre>
<h3 id="configure">2. Configure</h3>
<p>Next needed step is to configure server options. These options tell
the executor where to get the schema and also allows configuring the validation
rules for the execution. By default all validation rules from the GraphQL
specification are included.</p>
<pre><code class="language-csharp">
        private static void AddTanka(IServiceCollection services)
        {
            // Configure schema options
            services.AddTankaGraphQL()
                .ConfigureSchema&lt;SchemaCache&gt;(async cache =&gt; await cache.GetOrAdd());
        }

</code></pre>
<h3 id="configure-server">3. Configure server</h3>
<p>Server components require calling their <code>Add*</code> methods to add required
services and configure their options. Depending on the server also
middleware needs to be configured using the paired <code>Use*</code> methods.</p>
<p>Configure SignalR server</p>
<pre><code class="language-csharp">
        private static void AddSignalRServer(IServiceCollection services)
        {
            // Configure Tanka server
            services.AddSignalR()
                .AddTankaGraphQL();
        }

</code></pre>
<p>Use SignalR server</p>
<pre><code class="language-csharp">
        private static void UseSignalRServer(IApplicationBuilder app)
        {
            // add SignalR
            app.UseEndpoints(routes =&gt; { routes.MapTankaGraphQLSignalR(&quot;/graphql/hub&quot;); });
        }

</code></pre>
<p>Configure GraphQL WS server</p>
<pre><code class="language-csharp">
        private void AddWebSocketsServer(IServiceCollection services)
        {
            // Configure websockets
            services.AddWebSockets(options =&gt; { options.AllowedOrigins.Add(&quot;https://localhost:5000&quot;); });

            // Add Tanka GraphQL-WS server
            services.AddTankaGraphQL()
                .ConfigureWebSockets();
        }

</code></pre>
<p>Use GraphQL WS Server</p>
<pre><code class="language-csharp">
        private void UseWebSocketsServer(IApplicationBuilder app)
        {
            // Add Websockets middleware
            app.UseWebSockets();

            // Add Tanka GraphQL-WS middleware
            app.UseEndpoints(endpoints =&gt; endpoints.MapTankaGraphQLWebSockets(&quot;/graphql/ws&quot;));
        }

</code></pre>
<h3 id="http-api">4. HTTP API</h3>
<p>Tanka Server does not provide out of the box &quot;server&quot; for basic
HTTP/JSON API as that can be easily implemented.</p>
<p>Here's an example of ASP.NET Core MVC Controller taken from the
<code>Tanka.GraphQL.Samples.Chat.Web</code> project included in the solution.</p>
<p><code>IQueryStreamService</code> is registered by the <code>AddTankaGraphQL</code>
and is also used by the SignalR and GraphQL-WS based servers to
execute the queries.</p>
<p>[]</p>
<pre><code class="language-csharp">    [Route(&quot;api/graphql&quot;)]
    public class QueryController : Controller
    {
        private readonly IQueryStreamService _queryStreamService;

        public QueryController(IQueryStreamService queryStreamService)
        {
            _queryStreamService = queryStreamService;
        }

        [HttpPost]
        public async Task&lt;IActionResult&gt; Post([FromBody] OperationRequest request)
        {
            var stream = await _queryStreamService.QueryAsync(new Query
            {
                Document = ParseDocument(request.Query),
                Variables = request.Variables,
                OperationName = request.OperationName
            }, Request.HttpContext.RequestAborted);

            var result = await stream.Reader.ReadAsync();

            return Ok(result);
        }
    }

</code></pre>
                    
            </main>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
    
    <script type="text/javascript" src="2.0.0/prism.js"></script>
</body>
</html>

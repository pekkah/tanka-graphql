<!DOCTYPE html>
<html lang="en">

<head>
    <base href="/tanka-graphql/">
    <title>01-resolvers - Tanka GraphQL</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <link rel="stylesheet" href="2.0.0/prism.css" />
    <style>
        body {
            height: 100%;
            width: 100%;         
        }

        a {
            color: rgba(0,0,0,.65);
        }

        a:hover {
            color: rgba(8, 8, 8, 0.65);
        }

        blockquote {
            border: 1px solid rgba(94, 94, 94, 0.65);
            border-left: 5px solid rgba(94, 94, 94, 0.65);
            padding: 0.75rem 1.5rem;
            margin-top: 1rem;
            margin-bottom: 1rem;            
        }

        .sidebar {
            margin-bottom: 20px;
        }

        .sidebar .nav-item {
            list-style: none;
        }

        .sidebar .nav-link {
            display: block;
            padding: .25rem 1.5rem;
            font-size: 90%;
            color: rgba(0,0,0,.65);
        }

        .sidebar .nav-link:hover {
            text-decoration: underline;
        }

        .content h1,
        .content h2,
        .content h3,
        .content h4,
        .content h5,
        .content h6 {
            font-weight: 300;
        }

        
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="#">Tanka GraphQL</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto">
                <li class="nav-item">
                    <a class="nav-link" href="2.0.0/0-getting-started/01-create-schema.html">Getting Started</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="2.0.0/0-language/01-parser.html">Language</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="2.0.0/1-execution/01-resolvers.html">Execution</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="2.0.0/2-server/0-common.html">Server</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="2.0.0/3-code-generator/1-installation.html">Code Generation</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="2.0.0/7-type-system/02-schema.html">Type System</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="2.0.0/10-extensions/tracing.html">Extensions</a>
                </li>
        </ul>
        <ul class="navbar-nav ml-auto">
             <li class="nav-item">
                <a class="nav-link" href="https://github.com/pekkah/tanka-graphql">GitHub</a>
            </li>
            <li class="nav-item dropdown justify-content-end">
                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    2.0.0
                </a>
                <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                        <a class="dropdown-item" href="/tanka-graphql/master">master</a>
                        <a class="dropdown-item" href="/tanka-graphql/2.0.1">2.0.1</a>
                        <a class="dropdown-item" href="/tanka-graphql/2.0.0">2.0.0</a>
                </div>
            </li>
        </ul>
        </div>
    </nav>
    <div class="container-fluid">
        <div class="row flex-xl-nowrap">
            <nav class="col-12 col-md-3 col-xl-2 sidebar">
                <div class="sidebar-sticky">
    <nav class="nav flex-column">
<li class="nav-item">
    <a class="nav-link" href=2.0.0/1-execution/01-resolvers.html>Resolvers</a>
    <ul>
    </ul>
</li>    </nav>
    <nav class="nav flex-column">
<li class="nav-item">
    <a class="nav-link" href=2.0.0/1-execution/04-query.html>Query</a>
    <ul>
    </ul>
</li>    </nav>
    <nav class="nav flex-column">
<li class="nav-item">
    <a class="nav-link" href=2.0.0/1-execution/03-mutation.html>Mutation</a>
    <ul>
    </ul>
</li>    </nav>
    <nav class="nav flex-column">
<li class="nav-item">
    <a class="nav-link" href=2.0.0/1-execution/05-subscription.html>Subscription</a>
    <ul>
    </ul>
</li>    </nav>
    <nav class="nav flex-column">
<li class="nav-item">
    <a class="nav-link" href=2.0.0/1-execution/06-validation.html>Validation</a>
    <ul>
    </ul>
</li>    </nav>
                </div>
            </nav>
            <main role="main" class="col-12 col-md-8 col-xl-6 py-sm-1 py-md-3 pl-md-5 content">
                <h2 id="resolvers">Resolvers</h2>
<p>Resolving values is done with two specialized delegates. One is used resolving values and one for subscribing to streams when using subscriptions.</p>
<p>Resolve fields</p>
<pre><code class="language-csharp">﻿using System.Threading.Tasks;

namespace Tanka.GraphQL.ValueResolution
{
    public delegate ValueTask&lt;IResolverResult&gt; Resolver(IResolverContext context);
}
</code></pre>
<p>Resolve subscription event streams</p>
<pre><code class="language-csharp">﻿using System.Threading;
using System.Threading.Tasks;

namespace Tanka.GraphQL.ValueResolution
{
    public delegate ValueTask&lt;ISubscriberResult&gt; Subscriber(IResolverContext context, CancellationToken unsubscribe);
}
</code></pre>
<h3 id="resolver">Resolver</h3>
<p>When executing query or mutation <code>Resolver</code> is used to resolve the value of the field. Resolver can use the context to access field arguments, schema, and other details about the context of the execution.</p>
<h3 id="subscriber">Subscriber</h3>
<p>When executing subscription the <code>Subscriber</code> is used to resolve the event stream to subscribe into. Both <code>Subscriber</code> and <code>Resolver</code> are required for field when using subscriptions.</p>
<p><code>Subscriber</code> is responsible for resolving the source stream part of the <a href="https://facebook.github.io/graphql/June2018/#sec-Source-Stream">Specification</a>.</p>
<p><code>Resolver</code> is responsible for resolving the source stream values <a href="https://facebook.github.io/graphql/June2018/#sec-Response-Stream">Specification</a></p>
<h4 id="unsubscribe">Unsubscribe</h4>
<p><code>Subscriber</code> is given a cancellation token <code>unsubscribe</code> which will change into cancelled state when the request is unsubscribed <a href="https://facebook.github.io/graphql/June2018/#sec-Unsubscribe">Specification</a>.</p>
<h3 id="building-resolvers-with-fields">Building resolvers with fields</h3>
<p>Resolvers can be configured when creating fields. This configuration is used to build the actual resolver when <code>Schema</code> is built.</p>
<pre><code class="language-csharp">
        [Fact]
        public async Task Create_Field_Resolver()
        {
            /* Given */
            var builder = new SchemaBuilder();
            builder.Query(out var query)
                .Connections(connections =&gt;
                {
                    connections.Field(query, &quot;field1&quot;, ScalarType.String,
                        &quot;test field&quot;,
                        resolve =&gt; resolve.Run(context =&gt; new ValueTask&lt;IResolverResult&gt;(Resolve.As(42))));
                });


            /* When */
            var sut = builder.Build();

            /* Then */
            var result = await sut.GetResolver(query.Name, &quot;field1&quot;)(null);
            Assert.Equal(42, result.Value);
        }

</code></pre>
<pre><code class="language-csharp">
        [Fact]
        public async Task Create_Field_Subscriber()
        {
            /* Given */
            var builder = new SchemaBuilder();
            builder.Query(out var query)
                .Connections(connections =&gt;
                {
                    connections.Field(query, &quot;field1&quot;, ScalarType.String,
                        &quot;test field&quot;,
                        resolve =&gt; resolve.Run(context =&gt;
                            ResolveSync.As(42)),
                        subscribe =&gt; subscribe.Run((context, unsubscribe) =&gt;
                            ResolveSync.Subscribe(new EventChannel&lt;object&gt;(), unsubscribe)));
                });


            /* When */
            var sut = builder.Build();

            /* Then */
            var result = await sut.GetSubscriber(query.Name, &quot;field1&quot;)(null, CancellationToken.None);
            Assert.NotNull(result.Reader);
        }

</code></pre>
<p>Resolver middlwares can be used to build an execution chain.</p>
<p>Middlwares are implemented as a delegate method taking in the context and delegate for the next middlware to execute. Last link in the chain is usually the actual resolver but chain can be also interrupted before it by returning a result from the middleware.</p>
<p>Signature of the value resolver middlware:</p>
<pre><code class="language-csharp">﻿using System.Threading.Tasks;

namespace Tanka.GraphQL.ValueResolution
{
    public delegate ValueTask&lt;IResolverResult&gt; ResolverMiddleware(IResolverContext context, Resolver next);
}
</code></pre>
<p>Signature of the subscription middlware:</p>
<pre><code class="language-csharp">﻿using System.Threading;
using System.Threading.Tasks;

namespace Tanka.GraphQL.ValueResolution
{
    public delegate ValueTask&lt;ISubscriberResult&gt; SubscriberMiddleware(IResolverContext context, CancellationToken unsubscribe, Subscriber next);
}
</code></pre>
<h3 id="using-resolver-and-subscriber-maps">Using resolver and subscriber maps</h3>
<p>In some cases it's useful to be able to build the resolvers separately from the schema building. For that purpose <code>SchemaTools</code> provide a method to bind resolvers to fields by using <code>IResolverMap</code> and <code>ISubscriberMap</code>.</p>
<pre><code class="language-csharp">
        [Fact]
        public async Task Make_executable_schema()
        {
            /* Given */
            var builder = new SchemaBuilder()
                .Sdl(@&quot;
                    type Query {
                        field1: Int!
                    }

                    schema {
                        query: Query
                    }
                    &quot;
                );

            var resolvers = new ObjectTypeMap
            {
                {
                    &quot;Query&quot;, new FieldResolversMap
                    {
                        {
                            &quot;field1&quot;, async context =&gt;
                            {
                                await Task.Delay(1);
                                return Resolve.As(1);
                            }
                        }
                    }
                }
            };

            /* When */
            var executableSchema = SchemaTools.MakeExecutableSchema(
                builder: builder,
                resolvers: resolvers,
                subscribers: null,
                converters: null,
                directives: null);

            /* Then */
            var result = await Executor.ExecuteAsync(
                new ExecutionOptions
                {
                    Document = Parser.ParseDocument(@&quot;{ field1 }&quot;),
                    Schema = executableSchema
                });

            result.ShouldMatchJson(
                @&quot;{
                  &quot;&quot;data&quot;&quot;: {
                    &quot;&quot;field1&quot;&quot;: 1
                  }
                }&quot;);
        }

</code></pre>
<p>Dictionary based implementation is provided for setting up both resolvers and subscribers but other implementations can be easily provided.</p>
<pre><code class="language-csharp">﻿using System.Collections.Generic;
using Tanka.GraphQL.TypeSystem;
using Tanka.GraphQL.ValueResolution;

namespace Tanka.GraphQL
{
    public interface IResolverMap
    {
        Resolver GetResolver(string typeName, string fieldName);
    }

    public static class ResolverMapExtensions
    {
        public static Resolver GetResolver(this IResolverMap map, ComplexType type, KeyValuePair&lt;string, IField&gt; field)
        {
            return map.GetResolver(type.Name, field.Key);
        }
    }
}
</code></pre>
<pre><code class="language-csharp">﻿using System.Collections.Generic;
using Tanka.GraphQL.ValueResolution;
using Tanka.GraphQL.TypeSystem;

namespace Tanka.GraphQL
{
    public interface ISubscriberMap
    {
        Subscriber GetSubscriber(string typeName, string fieldName);
    }

    public static class SubscriberMapExtensions
    {
        public static Subscriber GetSubscriber(this ISubscriberMap map, ComplexType type,
            KeyValuePair&lt;string, IField&gt; field)
        {
            return map.GetSubscriber(type.Name, field.Key);
        }
    }
}
</code></pre>
                    
            </main>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
    
    <script type="text/javascript" src="2.0.0/prism.js"></script>
</body>
</html>
